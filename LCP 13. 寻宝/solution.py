from typing import List
from queue import Queue
from collections import defaultdict


class Solution:
    def minimalSteps(self, maze: List[str]) -> int:

        m = len(maze)
        n = len(maze[0])

        sp = []
        for i in range(m):
            for j in range(n):
                if maze[i][j] in ("M", "O", "S", "T"):
                    sp.append((i, j, maze[i][j]))
        x_step = (0, 1, 0, -1)
        y_step = (-1, 0, 1, 0)

        def bfs(x, y):
            q = Queue()
            q.put((x, y))
            temp = [[10000 for i in range(n)] for j in range(m)]

            temp[x][y] = 0

            while not q.empty():
                cur = q.get()
                cur_x, cur_y = cur[0], cur[1]
                for sx, sy in zip(x_step, y_step):
                    next_x, next_y = cur_x + sx, cur_y + sy
                    if next_x < 0 or next_x >= m or next_y < 0 or next_y >= n:
                        continue
                    if maze[next_x][next_y] == "#":
                        continue
                    if temp[next_x][next_y] > temp[cur_x][cur_y] + 1:
                        temp[next_x][next_y] = temp[cur_x][cur_y] + 1
                        q.put((next_x, next_y))

            res = []
            for i, j, _ in sp:
                res.append(temp[i][j])

            return res

        tag = defaultdict(list)
        dis = []
        for idx, (i, j, t) in enumerate(sp):
            dis.append(bfs(i, j))
            tag[t].append(idx)
        ids, idt = tag["S"][0], tag["T"][0]

        if "M" not in tag:
            res = dis[ids][idt]
            return res if res != 10000 else -1

        Mnum = len(tag["M"])
        Onum = len(tag["O"])

        dp = [[10000 for i in range(Mnum)] for i in range(1 << Mnum)]
        for i in range(Mnum):
            # 计算初始点到所有机关的最小距离, 作为dp的初始条件
            idxm = tag["M"][i]
            s = 1 << i
            for j in range(Onum):
                idxo = tag["O"][j]
                dp[s][i] = min(dp[s][i], dis[ids][idxo] + dis[idxo][idxm])

        Mdis = [[10000 for i in range(Mnum)] for i in range(Mnum)]
        for i in range(Mnum):
            # 计算每个机关之间的距离
            idxm1 = tag["M"][i]
            for j in range(Mnum):
                idxm2 = tag["M"][j]
                for k in range(Onum):
                    idxo = tag["O"][k]
                    Mdis[i][j] = min(Mdis[i][j], dis[idxm1][idxo] + dis[idxo][idxm2])

        for s in range(1 << Mnum):  # 遍历每一种状态
            for j in range(Mnum):
                if s & (1 << j) == 0: continue  # 如果在当前状态, 当前选中的起点机关没有开启, 则无法以j为基准推断下一步所需的步数(因为需要j已开启情况下的步数, dp), 遍历下一种情况

                for k in range(Mnum):
                    if s & (1 << k) != 0: continue  # 如果在当前状态, 准备前往的下一个机关已经开启, 则遍历下一种情况

                    ns = s | (1 << k)   # 机关k开启后的状态
                    dp[ns][k] = min(dp[ns][k], dp[s][j] + Mdis[j][k])   # 取 之前的步数 和 从j到k加j已开启情况下已经消耗的步数中的最小值
        ans = 10000
        fs = (1 << Mnum) - 1
        for j in range(Mnum):
            midx = tag['M'][j]
            ans = min(ans, dp[fs][j] + dis[midx][idt])
        if ans == 10000: ans = -1
        return ans

print(Solution().minimalSteps(["...#............#.....#.#.#...###...................#....#.........#...##........#..................","...O......##..............#......#.........#...........#...#....#.........#.........................","..#.#.........#....#........##..............#...................#........O.#...#.........#....#.....",".....#......#..#.#..#........##...........#.....#..................#........#....#..#...............",".#........................#...#...#..#..................................#........#.....#............",".........##......#........##.......#....................#..........O...........#.#.#......#........#","......#....#.......#.......#..#..................#.#............#............#..............#.......","............#..#......#.........#........#......#......#....#.............................#.........","#.#.##....................#...................................#...............#..#..#............#..","..................................................##.#........#...#..................#......#O.....#","#.............M................#..#.......................##.....#..........#..............#.#......","O....#.....#............#...##..........#.......#......#...................#........#...............","O.........................#.#....#..#............................#..........#.......#..........#....",".....O.........#.#..........#..........#.................#........##............#....#.......#......","#......#....#..............#....#............#............#.#.#....#................................","............##..#.....................#.......##..#.#.#........................................#....","...........#.......#...#..#............##..#.........#..#..#..#.........#..#.....#...........##.....","........#......#..#.#...O.....#....#....#............#..........#......#.....................#......","..#.....#..........#....##.#.....................#.#............##...#........##..........#O...#....","........#....#.#..........#..#..................................#..#....#...#.....#.....#.........#.",".#.........#.....................#..#.....#............#.....#.#.........#.......................#..",".....#............................#......##....#....................................#.#........#..#.",".#....#.#.........#............#.......................#.......................#.........#......#...",".......#..........#......................#..#..........#......O.......#..#....#...........O.........",".#O........M....#.##......O.....#......#.#..#...........#..#...#..#..............................#..","....................O...M..........#..........#...#.........#.............#...........#.#...........","#...#.#.....#........#......#.....#...........#...............#.##.....................#..#.........",".....#................#...................##.......#..#.............##...#..#.......................",".....##..........................##............#.............#..........#.#..................#......",".#.....................##.#......#.#.#..........#.#....#................#........#......#...#...#..#",".........#..........#.........O..............#.....M.................#.....#....#...................","...........#......#......##..........#....#.....#..........M...........#....#....##.......#.........","##...................................................#.....#.......##.#.............................","..........#........##..........#..................#......M.#.#.#.........#..........................","....#..#..M#.....M.....#..........M...........#.#............................#......................","..#......#..........#......#..#...##..................#..#...#...................#.......#...#..###.","..................#..#.#.................T..................#.............#..................#......","........#.#...#............#.................#...##.#......#..............#.........................","....#.............#.##.#.........#..##......#.#.#..................................................#","..#.......#.............#.#....#.#.......................#.....#..........#................#........","....#.......................#....#.............#....#....#..........##........#..............#......","#..................#.....O................#....#.#......#.........#......#......................#...","..........#...........#.......O.......##...........#.....................#.........................#","..#................................#.............................#.........#...........#............","..........#.....#.......#..................#............#.........#...#.........O.....#.............","#...#.............#....#........#......#..#........#..........#.............................#.#.....",".......#..........#........O#....#...#.........#...........................................#........",".....##.....#...#..#..#...#....................#......#..#......#...##......O.........#....##.......","................#.....#.........#.............................O.......#............................#",".........#.#.................#.....#....#.........#....#............................................","...#.#...........................#.......#......#............#.#......................###.....O..#..","...................#.#.#......#.......#...............................#......#....#....#............","#.#......#....#........#.#..#.#..........##...##.................#..........#.....................#.",".#....#.......................................#.....#..........#.....M#..........#.....#............","........#.....................#.#............#...............#.#..O.......#...................#.....","....#............................#.......#....#.................................................#...","..................#.#.......#..........#.....#.......#..............#...............#...............",".........................##.........#......#...............#.O..................##............#.....","..##......#..#........#.....................#....#......#.................#...........##.......#....","#..#..#............###..#...............#....#........#..........#..#...........#...............#O..","#..............................#...............#.#....#..#..#..#......#.......#.##............#.....","#.......S.......##.....#...........................###.#...........................#.#............#.",".................................#...........#...........#..........#.....#..#.#...#............#...","...........#....##.....#.............#..#...................................##....................#.","M.#....................#.#...O...............................M......O..................#....#.......","....M#.####........#......................................................#........#................","......#.#..................#................................................##....#.................","...#.............................................###..#...#........................#..#.......#.#...","........#.............O#..#.#....................#..#..#..........#....#.....#......#...#.......#...",".#..##..................#........#..........#........#....#.........##O...............#.....#.......","#.....#.#.#........#.......##....................#..........#.............#...#...#....##........#.#","................#.........#...........#.....#.......##....#..............#..........................","......O........#................##......#.#..................#.........#.............##.............",".#....#.#.........#...#...............#...........##.....#...........#..........M....#............#.","..............#...............O.......#......................#....................#...O..#..........","................#...#.#...#....................#.......#...#..............O.........................",".#................................##.............#...#.#.....#.#................#..#...#............",".....#..............#...............#...............................................................",".......................#....................##..#................#......................#..#.....#..",".........#..#....................#.............#..#......................#.......#..................","#..#........#....................................#.....#..............#..........#......#.#.......#.",".#......................#.....#......#........#....#...#......O#....#.........#....##...............","...........................#.....#...#.........#..#......#.....M......#....#...#............##...O##",".......................#...##............#.........#..............#....#....#..#...#.....#.#........",".#....#.......................#.....#O...#.............................#............#...............","...#.#..............#....M..............#.#.......#...#...#...#..........#........................##",".....#................#.#........#......#....................#.....#................................","....O.....#..................#.#..O...#.........#.......#.#..............#.....#.............#....#.",".......#..#.#..##......#...................#...............#.#.......#.........#....#......#..#....#",".....#.............#...#.......#.#.#........##.....#.#.....#....#......#.#...#................#.....","...............#..........#.#.##...................#.......................#.......##.....#..#.#....",".................#......#............................#...#...##........................#............","#........#........#..........#...#........#.#..#..............#...#.#.....#.#.#.#...................",".........#.#.......###.......#..........#.......#..........................................#........",".#..................#.....#......##.#...........#..........#.....#..................#............#.#","..................................................#.........#..#.#.....##....#...........#..........","......#...........#......#.......#...#.....................#.#............##................#....#..",".#..........................#........#........#.......#........#...#...........###...........#......","#...#...#.......#...................................##........O.........#.....#......#...#..........","#.......#.....#.#....#...#................O...................#..................#.......##........."]))